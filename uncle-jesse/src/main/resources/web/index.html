<html>
    <head>
        <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
        <script src="vertx-eventbus.js"></script>


    </head>

    <body>
        <div id="message"></div>
        <input type="file" accept="video/*"/>
        <video controls autoplay></video>

        <h1>Events</h1>
        <pre id="events"></pre>

        <script type="text/javascript">
            var eb = new EventBus("http://localhost:8080/eventbus");

            var display = function(err, msg) {
                var elem = document.getElementById("events");
                elem.innerText = elem.innerText + '\n' + new Date() + ' ' + msg.body
            };

            eb.onopen = function () {
                eb.registerHandler("Lost sheep Bo", display);
                eb.registerHandler("Lost sheep Luke", display);
                eb.registerHandler("Bo Peep", display);
                eb.registerHandler("Shepherd", display);
                eb.registerHandler("Red Dog", display);
                eb.registerHandler("Velvet ears", display);
                eb.registerHandler("Little fat buddy", display);
                eb.registerHandler("Crazy Cooter", display);
                eb.registerHandler("Dipstick", display);
                eb.registerHandler("Cletus", display);
                eb.registerHandler("STREAMADDED", function(err, msg) {
                    var videoNode = document.querySelector('video');
                    videoNode.src = "blob:" + msg.body.source;
                });
                eb.registerHandler("CANNYCONFIG", display);
                eb.registerHandler("HOUGHLINESCONFIG", display);
                eb.registerHandler("LANEDETECTION", display);
                eb.registerHandler("STARTLIGHTDETECTION", display);
            }

            //            function localFileVideoPlayer() {
            //                'use strict'
            var URL = window.URL || window.webkitURL
            var displayMessage = function (message, isError) {
                var element = document.querySelector('#message')
                element.innerHTML = message
                element.className = isError ? 'error' : 'info'
            };

            var playSelectedFile = function (event) {
                var file = this.files[0]
                var type = file.type
                var videoNode = document.querySelector('video')
                var canPlay = videoNode.canPlayType(type)
                if (canPlay === '') canPlay = 'no'
                var message = 'Can play type "' + type + '": ' + canPlay
                var isError = canPlay === 'no'
                displayMessage(message, isError)

                if (isError) {
                    return
                }

                var fReader = new FileReader();
                fReader.readAsDataURL(file);
                fReader.onloadend = function(event){

                var fileURL = URL.createObjectURL(file)
                eb.publish("STREAMADDED", {"source": fileURL.replace(/blob:/,''), "config": {"interval": 100}});
            };

            var inputNode = document.querySelector('input')

            inputNode.addEventListener('change', playSelectedFile, false)
            //            }
        </script>
    </body>
</html>
